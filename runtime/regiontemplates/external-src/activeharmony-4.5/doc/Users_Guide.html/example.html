<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Active Harmony User&#39;s Guide: Coding Examples</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Active Harmony User&#39;s Guide
   &#160;<span id="projectnumber">4.5</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('example.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Coding Examples </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Active Harmony provides two separate interfaces for the general user. One for establishing tuning sessions and the other for interacting with existing tuning sessions.</p>
<h1><a class="anchor" id="example_session_launch"></a>
Launching a New Session</h1>
<p>This example demonstrates how to use the session API to establish a session with four variables. It defines a function called <code>launch_tuner()</code> which, similar to the MPI's <code>mpi_init()</code> routine, is designed to accept the <code>argc</code> and argv<code>parameters from</code>main()`.</p>
<p>Code similar to <code>launch_tuner()</code> should be added to any target application that must establish a new tuning session for itself (as opposed to connecting to an existing tuning session, through the <a class="el" href="apps.html#apps_svr">Harmony Server</a>.</p>
<dl class="section note"><dt>Note:</dt><dd>To increase clarity, return values of API calls are not checked in this example. This is not recommended for production code.</dd></dl>
<div class="fragment"><div class="line"><span class="preprocessor">    #include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">    #include &quot;<a class="code" href="hclient_8h.html" title="Harmony client application function header.">hclient.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span> launch_tuner(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">    {</div>
<div class="line">        hdesc_t *hdesc;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Initialize a Harmony tuning session handle. */</span></div>
<div class="line">        hdesc = <a class="code" href="group__api__desc.html#gaee51d9eb6bc424581aeb1639058f2ff0" title="Allocate and initialize a new Harmony descriptor.">harmony_init</a>();</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Give the tuning session a unique name. */</span></div>
<div class="line">        <a class="code" href="group__api__sess.html#gade07324c5eb2eec8bd6768edb394062a" title="Specify a unique name for the Harmony session.">harmony_session_name</a>(hdesc, <span class="stringliteral">&quot;Example&quot;</span>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Add an integer variable called &quot;intVar1&quot; to the session.</span></div>
<div class="line"><span class="comment">           Its value may range between 1 and 100 (inclusive).</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <a class="code" href="group__api__sess.html#ga146f9e67c69a36dfb20967157c484b9b" title="Add an integer-domain variable to the Harmony session.">harmony_int</a>(hdesc, <span class="stringliteral">&quot;intVar1&quot;</span>, 1, 100, 1);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Add another integer variable called &quot;intVar2&quot; to the session.</span></div>
<div class="line"><span class="comment">           Its value may range between 2 and 200 (inclusive) by</span></div>
<div class="line"><span class="comment">           strides of 2.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <a class="code" href="group__api__sess.html#ga146f9e67c69a36dfb20967157c484b9b" title="Add an integer-domain variable to the Harmony session.">harmony_int</a>(hdesc, <span class="stringliteral">&quot;intVar2&quot;</span>, 2, 200, 2);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Add a real-valued variable called &quot;realVar&quot; to the session.</span></div>
<div class="line"><span class="comment">           Its value may range between 0.0 and 0.5 (inclusive), using the</span></div>
<div class="line"><span class="comment">           full precision available by an IEEE double.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <a class="code" href="group__api__sess.html#ga4e194a2691983bc74ff178588cacafe9" title="Add a real-domain variable to the Harmony session.">harmony_real</a>(hdesc, <span class="stringliteral">&quot;realVar&quot;</span>, 0.0, 0.5, 0.0);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Add a string-valued variable called &quot;strVar&quot; to the session.</span></div>
<div class="line"><span class="comment">           Its value may be &quot;apples&quot;, &quot;oranges&quot;, &quot;peaches&quot;, or &quot;pears&quot;.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <a class="code" href="group__api__sess.html#gad1447c1e2132fbc675305c0b16438247" title="Add an enumeration variable and append to the list of valid values in this set.">harmony_enum</a>(hdesc, <span class="stringliteral">&quot;strVar&quot;</span>, <span class="stringliteral">&quot;apples&quot;</span>);</div>
<div class="line">        <a class="code" href="group__api__sess.html#gad1447c1e2132fbc675305c0b16438247" title="Add an enumeration variable and append to the list of valid values in this set.">harmony_enum</a>(hdesc, <span class="stringliteral">&quot;strVar&quot;</span>, <span class="stringliteral">&quot;oranges&quot;</span>);</div>
<div class="line">        <a class="code" href="group__api__sess.html#gad1447c1e2132fbc675305c0b16438247" title="Add an enumeration variable and append to the list of valid values in this set.">harmony_enum</a>(hdesc, <span class="stringliteral">&quot;strVar&quot;</span>, <span class="stringliteral">&quot;peaches&quot;</span>);</div>
<div class="line">        <a class="code" href="group__api__sess.html#gad1447c1e2132fbc675305c0b16438247" title="Add an enumeration variable and append to the list of valid values in this set.">harmony_enum</a>(hdesc, <span class="stringliteral">&quot;strVar&quot;</span>, <span class="stringliteral">&quot;pears&quot;</span>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Connect to a Harmony Server at the default host (&quot;localhost&quot;),</span></div>
<div class="line"><span class="comment">           on the default port (1979), and initiate the tuning session</span></div>
<div class="line"><span class="comment">           we&#39;ve described using the above API calls.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="group__api__sess.html#ga47617410840a1fb1f41c03643f8e1449" title="Instantiate a new Harmony tuning session.">harmony_launch</a>(hdesc, NULL, 0) != 0) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Could not launch tuning session: %s\n&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__api__runtime.html#ga88cec85ed80ac67f5ca44206dcd74614" title="Access the current Harmony error string.">harmony_error_string</a>(hdesc));</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
</div><!-- fragment --><h1><a class="anchor" id="example_session_advanced"></a>
Advanced Session Configuration</h1>
<p>This example demonstrates the ability to specify <a class="el" href="intro.html#intro_session">session plug-ins</a>, and how to <a class="el" href="cfg.html">configure</a> them. Detailed descriptions of the valid configuration keys for each of the three plug-ins used in this example can be found in their respective manual pages:</p>
<ul>
<li><a class="el" href="nm.html">Nelder-Mead Search Strategy</a></li>
<li><a class="el" href="logger.html">Point Logger Processing Layer</a></li>
<li><a class="el" href="agg.html">Aggregator Processing Layer</a></li>
</ul>
<p>The following code snippet extends the code example in the <a class="el" href="example.html#example_session_launch">session launch</a> example. It may be inserted at any point before the call to <code><a class="el" href="group__api__sess.html#ga47617410840a1fb1f41c03643f8e1449" title="Instantiate a new Harmony tuning session.">harmony_launch()</a></code>.</p>
<dl class="section note"><dt>Note:</dt><dd>To increase clarity, return values of API calls are not checked in this example. This is not recommended for production code.</dd></dl>
<div class="fragment"><div class="line">        <span class="comment">/* Use the Nelder-Mead simplex-based as the strategy for this</span></div>
<div class="line"><span class="comment">           session, instead of the default Parallel Rank Order.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <a class="code" href="group__api__sess.html#gabaeee14ccfeca8abc7b6c497cc2760d8" title="Specify the search strategy to use in the new Harmony session.">harmony_strategy</a>(hdesc, <span class="stringliteral">&quot;nm.so&quot;</span>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Instruct the strategy to use an initial simplex roughly half</span></div>
<div class="line"><span class="comment">           the size of the search space.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <a class="code" href="group__api__runtime.html#ga7771680983a2f14e6aa8802f7e60d290" title="Set a new key/value pair in the session&#39;s configuration.">harmony_setcfg</a>(hdesc, <span class="stringliteral">&quot;INIT_PERCENT&quot;</span>, <span class="stringliteral">&quot;0.50&quot;</span>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* This tuning session should surround the search strategy with</span></div>
<div class="line"><span class="comment">           a logger layer first, and an aggregator layer second.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <a class="code" href="group__api__sess.html#ga7387b8ec3b536a42741aa6c05d5a21a5" title="Specify the list of plug-ins to use in the new Harmony session.">harmony_layer_list</a>(hdesc, <span class="stringliteral">&quot;log.so:agg.so&quot;</span>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Instruct the logger to use /tmp/tuning.run as the logfile. */</span></div>
<div class="line">        <a class="code" href="group__api__runtime.html#ga7771680983a2f14e6aa8802f7e60d290" title="Set a new key/value pair in the session&#39;s configuration.">harmony_setcfg</a>(hdesc, <span class="stringliteral">&quot;LOGFILE&quot;</span>, <span class="stringliteral">&quot;/tmp/tuning.run&quot;</span>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Instruct the aggregator to collect 10 performance values for</span></div>
<div class="line"><span class="comment">           each point, and allow the median performance to continue through</span></div>
<div class="line"><span class="comment">           the feedback loop.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <a class="code" href="group__api__runtime.html#ga7771680983a2f14e6aa8802f7e60d290" title="Set a new key/value pair in the session&#39;s configuration.">harmony_setcfg</a>(hdesc, <span class="stringliteral">&quot;AGG_TIMES&quot;</span>, <span class="stringliteral">&quot;10&quot;</span>);</div>
<div class="line">        <a class="code" href="group__api__runtime.html#ga7771680983a2f14e6aa8802f7e60d290" title="Set a new key/value pair in the session&#39;s configuration.">harmony_setcfg</a>(hdesc, <span class="stringliteral">&quot;AGG_FUNC&quot;</span>, <span class="stringliteral">&quot;median&quot;</span>);</div>
</div><!-- fragment --><h1><a class="anchor" id="example_client"></a>
Using the Client API</h1>
<p>The example demonstrates how to use the client API to join, fetch, and report to the tuning session established in the <a class="el" href="example.html#example_session_launch">session launch</a> example.</p>
<p>If this client was required to establish its own tuning session, a call to <a class="el" href="example.html#example_session_launch">launch_tuner()</a> from the example above could be added prior to the call to <a class="el" href="group__api__desc.html#gaee51d9eb6bc424581aeb1639058f2ff0" title="Allocate and initialize a new Harmony descriptor.">harmony_init()</a> on line 15.</p>
<dl class="section note"><dt>Note:</dt><dd>To increase clarity, return values of API calls are not checked in this example. This is not recommended for production code.</dd></dl>
<div class="fragment"><div class="line">    <span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">    {</div>
<div class="line">        hdesc_t *hdesc;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Variables to hold the application&#39;s runtime tunable parameters.</span></div>
<div class="line"><span class="comment">           Once bound to a Harmony tuning session, these variables will be</span></div>
<div class="line"><span class="comment">           modified upon harmony_fetch() to a new testing configuration.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordtype">long</span>        var1;</div>
<div class="line">        <span class="keywordtype">long</span>        var2;</div>
<div class="line">        <span class="keywordtype">double</span>      var3;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> *var4;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Initialize the Harmony client descriptor. */</span></div>
<div class="line">        hdesc = <a class="code" href="group__api__desc.html#gaee51d9eb6bc424581aeb1639058f2ff0" title="Allocate and initialize a new Harmony descriptor.">harmony_init</a>();</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Bind the session variables to local variables. */</span></div>
<div class="line">        <a class="code" href="group__api__client.html#ga429991a2b5c2ba152f5f42bf65e3ae00" title="Bind a local variable of type long to an integer-domain session variable.">harmony_bind_int</a>(hdesc,  <span class="stringliteral">&quot;intVar1&quot;</span>, &amp;var1);</div>
<div class="line">        <a class="code" href="group__api__client.html#ga429991a2b5c2ba152f5f42bf65e3ae00" title="Bind a local variable of type long to an integer-domain session variable.">harmony_bind_int</a>(hdesc,  <span class="stringliteral">&quot;intVar2&quot;</span>, &amp;var2);</div>
<div class="line">        <a class="code" href="group__api__client.html#gaa776de20b52b5d365c66666abd08c1a1" title="Bind a local variable of type double to a real-domain session variable.">harmony_bind_real</a>(hdesc, <span class="stringliteral">&quot;realVar&quot;</span>, &amp;var3);</div>
<div class="line">        <a class="code" href="group__api__client.html#ga07a67dd808853f0c7c260c5be1a9f152" title="Bind a local variable of type char * to an enumerated string-based session variable.">harmony_bind_enum</a>(hdesc, <span class="stringliteral">&quot;strVar&quot;</span>,  &amp;var4);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Join the tuning session we established above. */</span></div>
<div class="line">        <a class="code" href="group__api__client.html#ga668db156dd0ff627393baf08ce0a1585" title="Join an established Harmony tuning session.">harmony_join</a>(hdesc, NULL, 0, <span class="stringliteral">&quot;Example&quot;</span>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Loop until the session has reached a converged state. */</span></div>
<div class="line">        <span class="keywordflow">while</span> (!<a class="code" href="group__api__runtime.html#ga1d80aae3fbaeaf0b8d651a0a1e64d117" title="Retrieve the convergence state of the current search.">harmony_converged</a>(hdesc))</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">/* Define a variable to hold the resulting performance value. */</span></div>
<div class="line">            <span class="keywordtype">double</span> perf;</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Retrieve new values from the Harmony Session. */</span></div>
<div class="line">            <a class="code" href="group__api__runtime.html#gaed29a29f76e02d4477d95bbaf0564cf6" title="Fetch a new configuration from the Harmony server.">harmony_fetch</a>(hdesc);</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* The local variables var1, var2, var3, and var4 have now</span></div>
<div class="line"><span class="comment">               been updated and are ready for use.</span></div>
<div class="line"><span class="comment">              </span></div>
<div class="line"><span class="comment">               This is where a normal application would do some work</span></div>
<div class="line"><span class="comment">               using these variables and measure the performance.</span></div>
<div class="line"><span class="comment">               Since this is a simple example, we&#39;ll pretend the</span></div>
<div class="line"><span class="comment">               function &quot;work()&quot; will take the variables, and produce a</span></div>
<div class="line"><span class="comment">               performance value.</span></div>
<div class="line"><span class="comment">             */</span></div>
<div class="line">            perf = work(var1, var2, var3, var4);          </div>
<div class="line"></div>
<div class="line">            <span class="comment">/* Report the performance back to the session. */</span></div>
<div class="line">            <a class="code" href="group__api__runtime.html#gacccba5b35a62d02be0d909c5eb6e3df5" title="Report the performance of a configuration to the Harmony server.">harmony_report</a>(hdesc, perf);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Leave the session. */</span></div>
<div class="line">        <a class="code" href="group__api__client.html#gaedb41472bf449383a3e5f062cfd04172" title="Leave a Harmony tuning session.">harmony_leave</a>(hdesc);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.1.1 </li>
  </ul>
</div>
</body>
</html>
